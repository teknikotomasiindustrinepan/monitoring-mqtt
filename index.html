<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Monitoring MQTT via GitHub Pages</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .lamp {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 20px auto;
      background: gray;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      transition: background 0.3s, box-shadow 0.3s;
    }
    .lamp.on {
      background: yellow;
      box-shadow: 0 0 40px 15px yellow;
    }
    .lamp.off {
      background: #444;
      box-shadow: none;
    }
  </style>
</head>
<body style="font-family: Arial; text-align:center; margin:20px;">
  <h2>üì° Monitoring Data Sensor (Node-RED ‚Üí MQTT ‚Üí GitHub Pages)</h2>
  
  <div>
    <p><b>Data Terakhir:</b> <span id="latest">-</span></p>
  </div>

  <canvas id="myChart" width="400" height="200"></canvas>

  <h2>üí° Status Lampu</h2>
  <div id="lamp" class="lamp off"></div>
  <p id="status">Menunggu data lampu...</p>

  <script>
    // üîπ Konfigurasi MQTT Broker HiveMQ Public
    const broker = "wss://broker.hivemq.com:8884/mqtt"; 
    const topicSensor = "smk/monitoring/sensor"; 
    const topicLamp = "lamp/status"; // topik lampu

    // üîπ Connect ke broker
    const client = mqtt.connect(broker);

    client.on("connect", () => {
      console.log("‚úÖ Connected to MQTT broker");
      client.subscribe(topicSensor);
      client.subscribe(topicLamp);
    });

    // üîπ Setup Chart.js
    const ctx = document.getElementById("myChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Data Sensor",
          borderColor: "blue",
          fill: false,
          data: []
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: "Waktu" } },
          y: { title: { display: true, text: "Nilai" } }
        }
      }
    });

    // üîπ Saat ada pesan masuk
    client.on("message", (topic, message) => {
      const data = message.toString();

      if (topic === topicSensor) {
        console.log("Sensor:", data);
        document.getElementById("latest").innerText = data;

        const now = new Date().toLocaleTimeString();
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(parseFloat(data));

        if (chart.data.labels.length > 20) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }

        chart.update();
      }

      if (topic === topicLamp) {
        console.log("Lamp:", data);
        const lamp = document.getElementById("lamp");
        const text = document.getElementById("status");

        if (data === "ON") {
          lamp.className = "lamp on";
          text.textContent = "Lampu MENYALA üí°";
        } else {
          lamp.className = "lamp off";
          text.textContent = "Lampu MATI ‚ùå";
        }
      }
    });
  </script>
</body>
</html>
